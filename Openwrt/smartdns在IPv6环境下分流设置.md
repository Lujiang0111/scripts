# smartdns在IPv6环境下分流设置

## smartdns页面设置

1. 添加上游服务器
    + 服务器组分为**default**和**overseas**两组，修改dns所属分组的方法是点击每个dns右端的**修改**按钮，修改**服务器组**为```default```与```overseas```即可。
        | 名称 | IP | 端口 | 协议类型 | 服务器组 | 从默认服务器组排除 |
        | - | - | - | - | - | - |
        | Ali | 223.5.5.5 | 53 | udp | default | |
        | Tencent | 119.29.29.29 | 53 | udp | default | |
        | Cloudflare | 1.1.1.1 | 853 | tls | overseas | ✔ |
        | Google | 8.8.4.4 | 853 | tls | overseas | ✔ |

2. 配置主DNS服务器
    + 点击**常规设置**选项卡，勾选**启用**，服务器名称填写```smartdns```，本地端口填写```5333```。
    + 点击**高级设置**选项卡，按下表所示配置。
        | 名称 | 设置值 |
        | - | - |
        | 测速模式 | ping,tcp:80,tcp:443 |
        | TCP服务器 | ✔ |
        | IPv6服务器 | ✔ |
        | 双栈IP优选 | ✔ |
        | 域名预加载 | ❌ |
        | 缓存过期服务 | ✔ |
        | 缓存大小 | 0 |
        | 解析本地主机名 | ✔ |
        | 自动设置dnsmasq | ✔ |
        | 停用IPv6地址解析 | ❌ |
        | 停用Https地址解析 | ❌ |
    + 点击**自定义设置**选项卡，设置双栈IP优选的时间差```dualstack-ip-selection-threshold 15```。
    + 点击**保存并应用**启用主DNS服务器。
    + 点击luci界面左侧**网络**->**DHCP/DNS**，检查**DNS 转发**项是否被设置为```127.0.0.1#5333```。

3. 配置第二DNS服务器
    + 点击**第二DNS服务器**选项卡，按下表所示配置，点击**保存并应用**启用第二DNS服务器。
        | 名称 | 设置值 |
        | - | - |
        | 启用 | ✔ |
        | 本地端口 | 5335 |
        | TCP服务器 | ❌ |
        | 服务器组 | overseas |
        | 跳过测速 | ✔ |
        | 跳过address规则 | ✔ |
        | 跳过Nameserver规则 | ✔ |
        | 跳过ipset规则 | ✔ |
        | 跳过address SOA(#)规则 | ✔ |
        | 跳过双栈优选 | ✔ |
        | 跳过cache | ✔ |
        | 停用IPv6地址解析 | ✔ |

## passwall设置

+ 点击**DNS**选项卡，按下表所示配置。
    | 名称 | 设置值 |
    | - | - |
    | 过滤代理域名 IPv6 | ❌ |
    | 过滤模式 | 通过UDP请求DNS |
    | 远程DNS | 127.0.0.1:5335 |
