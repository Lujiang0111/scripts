# 旁路网关是否要加IP动态伪装的探讨

## 结论

+ 如果能取消桥接，建议取消桥接，并添加```iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE```命令。

+ 如果无法取消桥接，建议添加```iptables -t nat -I POSTROUTING -o br-lan -j MASQUERADE```命令。

## 是否要添加命令

### 讨论1

1. 当终端设备可以手动设定网关和 DNS 指向旁路网关，访问某些网站服务器时：上行数据包路径：终端设备 -> 旁路网关 -> 主路由 -> Internet -> 某网站服务器。

    如果不添加防火墙规则，由于主路由和终端设备在同一网段，数据包会直接返给终端设备：下行数据包路径：某网站服务器 -> Internet -> 主路由 -> 终端设备。

    此时，由于路由不能闭合，可能导致旁路网关一直收不到下行数据包，造成大量 TCP 连接不能关闭，最终形成网络拥塞或卡顿，所以才会建议在旁路网关上添加防火墙规则：```iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE```。

    这条命令的目的，是把从终端设备发送的上行数据包源地址伪装成旁路网关自身地址，于是，主路由返回的下行数据包才会先发送到旁路网关，再由旁路网关发送到终端设备，最终形成一个闭合的 TCP 连接，即：下行数据包路径：某网站服务器 -> Internet -> 主路由 -> 旁路网关 -> 终端设备。

    由于命令中使用 eth0 接口，所以才会建议在旁路网关中取消桥接 br-lan 以规避发送桥接广播，如果终端设备使用固定 IP 就可以直接使用 SNAT 处理，以节省部分计算资源。

2. 实际使用中，可能某些局域网终端设备不能手动设定网关和 DNS 指向旁路网关，或者局域网设备很多，逐一手动指定工作量太大，这时将主路由和旁路网关互相指向，目的是接管局域网的所有数据包流量；

    这时，终端设备发送的上行数据包路径不变，但下行数据包到达主路由后，由于主路由 LAN 口网关和 DNS 已提前指向旁路网关，下行数据包不会直接发送给终端设备，而是会先发送到旁路网关，再由旁路网关发给终端设备，最终形成 TCP 闭环。

    理论上，这种情况下就不需要在旁路网关中添加 iptables 防火墙规则了，但桥接还是建议取消，可以减少旁路网关 CPU 发送桥接广播的部分工作量。

    实际使用中，不取消桥接也可以，毕竟旁路网关只有一个 eth0 桥接广播实际上是自己发给自己，只是这种情况下，数据包在局域网中传输路径多出来回两小段，当终端设备很多时，可能会出现 TCP 包的排队拥塞，不过，在家庭网络中终端设备不多，但在商用网络中，特别是有 Internet 和 Intranet 两个网关的情况下，就可能出现拥塞。

### 讨论2

1. 不加防火墙规则不能上网的，一般是华为、小米、360等主路由器，原因是，这些路由器会校验数据包的ip和mac地址的对应关系。国内包的上行经过旁路由转发给主路由时，主路由发现旁路由发过来的数据包ip不是它自己的，校验失败，所以网络不通了。

    然后加了防火墙规则，上边那条规则的意思是执行SNAT功能，就是把数据包的源ip改成当前机器的，也就是旁路由的ip。这样ip和mac地址对应，网络通了。
